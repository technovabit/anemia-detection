<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Curriculum & Attendance with Face Recognition</title>
<style>
  /* Same CSS as previous with slight additions for profile images and announcements */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(-45deg, #1e3a8a, #3b82f6, #1e3a8a, #3b82f6);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    min-height: 100vh;
    color: #222;
    line-height: 1.6;
    overflow-x: hidden;
  }
  @keyframes gradientBG {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }
  
  header {
    background: rgba(30, 58, 138, 0.85);
    color: #fff;
    padding: 1em 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: slideDownFade 1s ease forwards;
    opacity: 0;
  }
  header h1 { font-size: 1.6rem; font-weight: 700; }
  @keyframes slideDownFade {
    0% {opacity: 0;transform: translateY(-30px);}
    100% {opacity: 1;transform: translateY(0);}
  }
  
  .hero {
    max-width: 800px;
    margin: 2rem auto 1rem auto;
    background: rgba(30, 58, 138, 0.9);
    color: #fff;
    padding: 3rem 2rem;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    text-align: center;
    animation: fadeInUp 1.4s ease forwards;
    opacity: 0;
    transform: translateY(25px);
  }
  .hero h2 {
    font-size: 2rem;
    margin-bottom: 0.75rem;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
  }
  .hero p {
    font-size: 1.1rem;
    margin-bottom: 1.5rem;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
  }
  /* Removed old CTA buttons as requested */


  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
    from {
      opacity: 0;
      transform: translateY(25px);
    }
  }
  
  .btn {
    background: #ffd700;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-weight: 600;
    cursor: pointer;
    margin: 0 0.5rem 0.5rem 0.5rem;
    box-shadow: 0 5px 10px rgba(255,215,0,0.5);
    transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
  }
  .btn:hover {
    background: #facc15;
    box-shadow: 0 8px 20px rgba(250,204,21,0.8);
    transform: scale(1.05);
  }
  .btn:active { transform: scale(0.95); }
  
  section {
    max-width: 1100px;
    background: #fff;
    margin: 2rem auto;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    display: none;
  }
  section h2 {
    text-align: center;
    margin-bottom: 1.75rem;
    color: #1e3a8a;
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
  }
  .features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.25rem;
  }
  .card {
    background: #fff;
    border-radius: 10px;
    padding: 1.2rem 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.07);
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }
  .card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    transform: translateY(-6px);
  }
  .card h3 {
    color: #3b82f6;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }
  .card p { font-size: 1rem; color: #444; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.95rem;
  }
  th, td {
    padding: 10px 12px;
    border: 1px solid #ddd;
    text-align: left;
    vertical-align: middle;
  }
  th {
    background: #3b82f6;
    color: white;
    font-weight: 600;
  }
  tbody tr:hover { background: #f1f5f9; }
  input[type="text"], input[type="password"], input[type="time"], input[type="number"], input[type="date"], select {
    width: 95%;
    padding: 0.5rem;
    margin-bottom: 0.75rem;
    border: 1px solid #aaa;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus { border-color: #3b82f6; outline: none; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 680px) { .grid-2 { grid-template-columns: 1fr; } }
  .toolbar { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1.5rem; }
  .calendar {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .calendar button {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: 1px solid #aaa;
    background: #fff;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  .calendar button:hover { background: #facc15; box-shadow: 0 4px 12px rgba(250,204,21,0.6); }
  .selected-day { background: #3b82f6; color: #fff; box-shadow: 0 0 12px 2px #3b82f6; }
  .att-btns button { margin-right: 0.5rem; }
  .selected { border: 2px solid green !important; box-shadow: 0 0 8px 2px green; }
  #loginPage {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, rgba(30,58,138,0.85), rgba(59,130,246,0.85));
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease;
  }
  #loginPage.hidden { opacity: 0; pointer-events: none; }
  .login-box {
    background: #fff;
    padding: 2rem 2.5rem;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    max-width: 400px;
    width: 90%;
    text-align: center;
  }
  .login-box h2 { font-weight: 700; margin-bottom: 1.25rem; font-size: 1.5rem; color: #1e3a8a; }
  .login-box p { margin-top: 1rem; font-size: 0.9rem; color: #555; }
  #modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 1rem;
  }
  #modal.show { display: flex; }
  .modal-content {
    background: #fff;
    border-radius: 12px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    position: relative;
    padding: 1.5rem 2rem;
    animation: popUp 0.4s ease forwards;
  }
  @keyframes popUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #modal .close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    font-weight: 700;
    cursor: pointer;
    color: #333;
    transition: color 0.3s ease;
  }
  #modal .close:hover { color: #3b82f6; }
  footer {
    background: rgba(30, 41, 59, 0.9);
    color: #fff;
    text-align: center;
    padding: 1.2rem 1rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    box-shadow: inset 0 1px 0 rgb(255 255 255 / 0.1);
  }
  #contact p a {
    color: #1e3a8a;
    font-weight: 700;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  #contact p a:hover {
    color: #3b82f6;
    text-decoration: underline;
  }
  video#camVideo {
    border-radius: 8px;
    width: 100%;
    height: 220px;
    background: #000;
  }
  #captures {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
    gap: 0.5rem;
  }
  #tt-card table input {
    width: 90%;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #ddd;
    font-size: 0.95rem;
  }
  #tt-card table button.remove-period {
    background: #ef4444;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  #tt-card table button.remove-period:hover {
    background: #dc2626;
  }
  /* Student photo style in student management table */
  .student-photo {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 50%;
    border: 1.5px solid #3b82f6;
    vertical-align: middle;
    margin-right: 8px;
  }
  /* File input hidden */
  .photo-upload {
    display: none;
  }

  /* Announcements and quick links lists */
  #announcementsList, #quickLinksList, #studentAnnouncementsContent ul {
    list-style-type: disc;
    margin-left: 1.5rem;
  }
  #announcementsList li, #quickLinksList li {
    margin-bottom: 0.5rem;
  }
  #announcementsList li button, #quickLinksList li button {
    margin-left: 10px;
    padding: 0 6px;
    font-size: 0.8rem;
  }
  #studentAnnouncementsContent a {
    color: #3b82f6;
    text-decoration: none;
  }
  #studentAnnouncementsContent a:hover {
    text-decoration: underline;
  }
</style>

<!-- Load face-api.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

</head>
<body>

<header>
  <h1>Smart Curriculum & Attendance</h1>
  <button class="btn" id="facultyLogoutBtn" style="float:right;margin-top:-8px;display:none;">Logout</button>
</header>

<!-- Buttons at top -->
<div style="text-align:center; max-width: 900px; margin: 1rem auto;">
  <button class="btn" onclick="openModal('timetable')" style="margin-bottom: 1rem;">Check / Edit Today's Timetable</button>
  <button class="btn" onclick="openModal('activities')" style="margin-bottom: 1rem;">Add / View Activities</button>
  <button class="btn" onclick="openModal('smartAttendance')" style="margin-bottom: 1rem;">Smart Attendance (Camera)</button>
</div>

<section id="timetable">
  <h2>Today's Timetable</h2>
  <div class="card" id="tt-card"></div>
</section>

<section id="features" style="display:block;">
  <h2>Key Features</h2>
  <div class="features">
    <div class="card">
      <h3>📋 Easy Attendance</h3>
      <p>Mark attendance digitally with instant reports and export options.</p>
    </div>
    <div class="card">
      <h3>📅 Curriculum Planner</h3>
      <p>Organize schedules and classes easily, letting faculty manage timetables efficiently.</p>
    </div>
    <div class="card">
      <h3>📊 Analytics Dashboard</h3>
      <p>Monthly & weekly attendance summaries visualized with simple charts.</p>
    </div>
    <div class="card">
      <h3>🎯 Activity Scheduling</h3>
      <p>Manage student lists, assign activities, and track them effectively.</p>
    </div>
  </div>
</section>

<!-- New Announcements and Quick Links Section for Faculty -->
<section id="announcements">
  <h2>Latest Announcements & Quick Links</h2>
  <div class="card">
    <h3>Add Announcement</h3>
    <input type="text" id="newAnnouncement" placeholder="Enter announcement..." />
    <button class="btn" onclick="addAnnouncement()">Add Announcement</button>

    <h3 style="margin-top: 1rem;">Add Quick Link</h3>
    <input type="text" id="newQuickLinkText" placeholder="Link text..." />
    <input type="text" id="newQuickLinkURL" placeholder="Link URL (https://...)" />
    <button class="btn" onclick="addQuickLink()">Add Quick Link</button>

    <h3 style="margin-top: 1.5rem;">Current Announcements</h3>
    <ul id="announcementsList"></ul>

    <h3 style="margin-top: 1.5rem;">Current Quick Links</h3>
    <ul id="quickLinksList"></ul>
  </div>
</section>

<!-- Student Portal Announcements and Quick Links -->
<section id="studentAnnouncements" style="display:block; max-width: 900px; margin: 2rem auto; background:#fff; padding:1rem 2rem; border-radius:12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);">
  <h2>Announcements & Quick Links</h2>
  <div id="studentAnnouncementsContent"></div>
</section>

<section id="studentManagement">
  <h2>Student Management & Login</h2>
  <div class="card">
    <div class="grid-2">
      <div>
        <h3>Add New Student</h3>
        <input type="text" id="newStudentName" placeholder="Student name..." autocomplete="off" />
        <input type="text" id="newStudentUser" placeholder="Username" autocomplete="off" />
        <input type="password" id="newStudentPass" placeholder="Password" autocomplete="new-password" />
        <label for="photoUploadInput" class="btn" style="display:inline-block;cursor:pointer;">Upload Photo</label>
        <input type="file" id="photoUploadInput" class="photo-upload" accept="image/*" />
        <img id="previewPhoto" style="display:none; margin-top: 10px; width: 80px; height:80px; object-fit:cover; border-radius: 50%; border: 1.5px solid #3b82f6;" alt="Profile Preview" />
        <br />
        <button class="btn" onclick="addStudentWithLogin()">Add Student</button>
      </div>
      <div>
        <h3>Manage Students</h3>
        <table id="students-manage" style="vertical-align: middle;">
          <thead>
            <tr><th>Photo</th><th>Name</th><th>Username</th><th>Password</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<section id="attendance">
  <h2>Mark Attendance</h2>
  <div class="calendar" id="calendarDays"></div>
  <div class="toolbar">
    <button class="btn" onclick="openModal('markAttendance')">Mark Attendance</button>
    <button class="btn" onclick="openModal('studentAnalysis')">Student Analysis</button>
    <button class="btn" onclick="openModal('qrAttendance')">Generate QR Code for Attendance</button>
    <button class="btn" onclick="clearAttendance()">Clear Attendance for Selected Date</button>
  </div>
  <div id="attendance-table" class="card">
    <table>
      <thead><tr><th>Student</th><th>Status</th></tr></thead>
      <tbody id="students-body"></tbody>
    </table>
  </div>
</section>

<section id="activities">
  <h2>Faculty & Student Activities</h2>
  <div class="card">
    <div>
      <h3>Add New Activity</h3>
      <input type="text" id="activityName" placeholder="Activity name..." />
      <input type="date" id="activityDate" />
      <button class="btn" onclick="addActivity()">Add Activity</button>
    </div>
    <div style="margin-top: 1rem;">
      <h3>All Activities</h3>
      <table id="activities-table">
        <thead>
          <tr><th>Activity</th><th>Date</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

<section id="contact">
  <h2>Contact Us</h2>
  <p style="text-align:center;">
    📧 <a href="mailto:team@smartapp.com">team@smartapp.com</a> | ☎️ +91 98765 43210
  </p>
</section>

<footer>
  <p>© 2025 Smart Curriculum & Attendance App</p>
</footer>

<div id="loginPage">
  <div class="login-box">
    <h2>Faculty Login</h2>
    <input id="loginUser" type="text" placeholder="Username" autocomplete="username" />
    <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password" />
    <button class="btn" onclick="submitLogin()">Login</button>
  </div>
</div>

<!-- Modal -->
<div id="modal" aria-hidden="true" role="dialog" aria-labelledby="modal-title" aria-modal="true" tabindex="-1">
  <div class="modal-content" role="document">
    <span class="close" onclick="closeModal()" aria-label="Close modal">&times;</span>
    <h3 id="modal-title"></h3>
    <div id="modal-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
// QR Code Attendance
// Load QRCode.js from CDN
if (!window.QRCode) {
  var qrScript = document.createElement('script');
  qrScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
  document.head.appendChild(qrScript);
}

function renderQrAttendance(container) {
  // Get timetable periods
  const periods = JSON.parse(localStorage.getItem('timetableData') || '[]');
  let html = '<h4>Select Period to Generate QR</h4>';
  html += '<select id="qrPeriodSelect">';
  periods.forEach(p => {
    html += `<option value="${p.period}">${p.period}: ${p.subject} (${p.start} - ${p.end})</option>`;
  });
  html += '</select>';
  html += '<button class="btn" id="generateQrBtn" style="margin-left:1rem;">Generate QR Code</button>';
  html += '<div id="qrCodeContainer" style="margin-top:2rem;text-align:center;"></div>';
  html += '<div id="qrTimer" style="margin-top:1rem;font-weight:bold;color:#ef4444;"></div>';
  container.innerHTML = html;

  document.getElementById('generateQrBtn').onclick = function() {
    const period = document.getElementById('qrPeriodSelect').value;
    generateQrCode(period);
  };
}

let qrTimerInterval = null;
function generateQrCode(period) {
  // QR data: date, period, expiry
  const now = new Date();
  const expiry = new Date(now.getTime() + 60000); // 1 min expiry
  const qrData = JSON.stringify({
    date: selectedISODate,
    period: period,
    expires: expiry.getTime()
  });
  const qrContainer = document.getElementById('qrCodeContainer');
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: qrData,
    width: 220,
    height: 220
  });
  // Timer
  const timerEl = document.getElementById('qrTimer');
  let secondsLeft = 60;
  timerEl.textContent = `QR code expires in ${secondsLeft} seconds.`;
  if (qrTimerInterval) clearInterval(qrTimerInterval);
  qrTimerInterval = setInterval(() => {
    secondsLeft--;
    if (secondsLeft <= 0) {
      timerEl.textContent = 'QR code expired.';
      qrContainer.innerHTML = '<p style="color:#ef4444;font-weight:bold;">Expired</p>';
      clearInterval(qrTimerInterval);
    } else {
      timerEl.textContent = `QR code expires in ${secondsLeft} seconds.`;
    }
  }, 1000);
}
let loggedIn = false;
let cameraStream = null;
let selectedDate = new Date();
selectedDate.setHours(0,0,0,0);
let selectedISODate = selectedDate.toISOString().split('T')[0];

// Store student face descriptors (loaded on app init)
let labeledFaceDescriptors = null;
let faceMatcher = null;

// Preview uploaded photo in add student
const photoInput = document.getElementById('photoUploadInput');
const photoPreview = document.getElementById('previewPhoto');
photoInput.addEventListener('change', (e) => {
  if (e.target.files && e.target.files[0]) {
    let reader = new FileReader();
    reader.onload = function(ev) {
      photoPreview.src = ev.target.result;
      photoPreview.style.display = 'inline-block';
    }
    reader.readAsDataURL(e.target.files[0]);
  }
});

// Login
function submitLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  // Use faculties from localStorage
  const faculties = JSON.parse(localStorage.getItem('faculties') || '[]');
  if (faculties.find(f => f.username === user && f.password === pass)) {
    loggedIn = true;
    const loginPage = document.getElementById('loginPage');
    loginPage.classList.add('hidden');
    setTimeout(() => {
      loginPage.style.display = 'none';
      document.querySelectorAll('section').forEach(s => s.style.display = 'block');
      document.getElementById('facultyLogoutBtn').style.display = 'inline-block';
      initApp();
    }, 500);
  } else {
    alert('Invalid credentials!');
  }
}

// Initialize application data and UI
async function initApp() {
  if (!localStorage.getItem('students')) localStorage.setItem('students', JSON.stringify([]));
  if (!localStorage.getItem('timetableData'))
    localStorage.setItem('timetableData', JSON.stringify([
      { period: 1, subject: 'Math', start: '09:00', end: '09:45' },
      { period: 2, subject: 'Science', start: '09:50', end: '10:35' },
      { period: 3, subject: 'English', start: '10:40', end: '11:25' },
    ]));
  if (!localStorage.getItem('attendanceRecords')) localStorage.setItem('attendanceRecords', JSON.stringify({}));
  if (!localStorage.getItem('activities')) localStorage.setItem('activities', JSON.stringify([]));
  if (!localStorage.getItem('announcements')) localStorage.setItem('announcements', JSON.stringify([]));
  if (!localStorage.getItem('quickLinks')) localStorage.setItem('quickLinks', JSON.stringify([]));
  
  renderCalendar();
  refreshStudentManage();
  renderAttendanceTable();
  renderTodayTimetable();
  renderActivities();

  renderAnnouncements();
  renderQuickLinks();
  renderStudentAnnouncements();

  // Load face-api models from CDN
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
    faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
    faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
  ]);

  await loadLabeledFaces();
}

// Manage students
function refreshStudentManage() {
  const tbody = document.querySelector('#students-manage tbody');
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  tbody.innerHTML = '';
  students.forEach((s, i) => {
    const tr = document.createElement('tr');
    const imgSrc = s.photo || '';
    tr.innerHTML = `
      <td><img src="${imgSrc}" alt="Profile photo" class="student-photo" /></td>
      <td>${s.name}</td>
      <td>${s.username}</td>
      <td>${s.password}</td>
      <td><button class="btn" onclick="removeStudent(${i})">Remove</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function addStudentWithLogin() {
  if (!loggedIn) return alert('Please login first');
  const name = document.getElementById('newStudentName').value.trim();
  const user = document.getElementById('newStudentUser').value.trim();
  const pass = document.getElementById('newStudentPass').value.trim();
  const photo = photoPreview.src || '';
  if (!name || !user || !pass) return alert('Fill all fields');
  if (!photo || photo === '') return alert('Please upload a photo');
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  students.push({ name, username: user, password: pass, photo });
  localStorage.setItem('students', JSON.stringify(students));
  document.getElementById('newStudentName').value = '';
  document.getElementById('newStudentUser').value = '';
  document.getElementById('newStudentPass').value = '';
  photoPreview.style.display = 'none';
  photoPreview.src = '';
  photoInput.value = '';
  refreshStudentManage();
  renderAttendanceTable();
  loadLabeledFaces(); // reload face descriptors for matching
}

function removeStudent(i) {
  if (!loggedIn) return alert('Please login first');
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  students.splice(i, 1);
  localStorage.setItem('students', JSON.stringify(students));
  refreshStudentManage();
  renderAttendanceTable();
  loadLabeledFaces(); // reload face descriptors for matching
}

// Load labeled face descriptors for recognition
function loadLabeledFaces() {
  return new Promise((resolve) => {
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    labeledFaceDescriptors = [];
    if (students.length === 0) {
      faceMatcher = null;
      return resolve();
    }
    Promise.all(students.map(async s => {
      try {
        const img = await faceapi.fetchImage(s.photo);
        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
        if (detections) {
          return new faceapi.LabeledFaceDescriptors(s.username, [detections.descriptor]);
        }
      } catch (e) {
        console.warn("Failed to process face for user:", s.username);
      }
      return null;
    })).then(results => {
      labeledFaceDescriptors = results.filter(x => x !== null);
      if (labeledFaceDescriptors.length > 0) {
        faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.6);
      } else {
        faceMatcher = null;
      }
      resolve();
    });
  });
}

// Timetable (Add/Remove/Update periods)
function renderTodayTimetable() {
  const container = document.getElementById('tt-card');
  const data = JSON.parse(localStorage.getItem('timetableData') || '[]');
  let html = '<table><thead><tr><th>Period</th><th>Subject</th><th>Start</th><th>End</th><th>Action</th></tr></thead><tbody>';
  data.forEach((r, i) => {
    html += `<tr>
      <td>${r.period}</td>
      <td><input type="text" value="${r.subject}" id="sub-${i}"></td>
      <td><input type="time" value="${r.start}" id="start-${i}"></td>
      <td><input type="time" value="${r.end}" id="end-${i}"></td>
      <td>
        <button class="btn" onclick="updatePeriod(${i})">Save</button>
        <button class="remove-period" onclick="removePeriod(${i})" title="Remove this period">&times;</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  html += `
    <div style="margin-top:1rem;">
      <h4>Add New Period</h4>
      <input type="number" id="newPeriodNum" placeholder="Period number" style="width:90px;" min="1" />
      <input type="text" id="newPeriodSub" placeholder="Subject" />
      <input type="time" id="newPeriodStart" />
      <input type="time" id="newPeriodEnd" />
      <button class="btn" onclick="addPeriod()">Add Period</button>
    </div>
  `;
  container.innerHTML = html;
}

function updatePeriod(i) {
  const data = JSON.parse(localStorage.getItem('timetableData') || '[]');
  data[i].subject = document.getElementById(`sub-${i}`).value;
  data[i].start = document.getElementById(`start-${i}`).value;
  data[i].end = document.getElementById(`end-${i}`).value;
  localStorage.setItem('timetableData', JSON.stringify(data));
  alert('Updated successfully!');
  renderTodayTimetable();
}

function addPeriod() {
  const period = document.getElementById('newPeriodNum').value;
  const subject = document.getElementById('newPeriodSub').value;
  const start = document.getElementById('newPeriodStart').value;
  const end = document.getElementById('newPeriodEnd').value;
  if (!period || !subject || !start || !end) return alert('Fill all fields');
  const data = JSON.parse(localStorage.getItem('timetableData') || '[]');
  if(data.find(d => d.period === parseInt(period))) {
    alert('Period number already exists.');
    return;
  }
  data.push({ period: parseInt(period), subject, start, end });
  data.sort((a,b) => a.period - b.period);
  localStorage.setItem('timetableData', JSON.stringify(data));
  renderTodayTimetable();
}

function removePeriod(i) {
  const data = JSON.parse(localStorage.getItem('timetableData') || '[]');
  if (!confirm(`Remove period ${data[i].period}?`)) return;
  data.splice(i, 1);
  localStorage.setItem('timetableData', JSON.stringify(data));
  renderTodayTimetable();
}

// Activities (Same as before)
function renderActivities() {
  const tbody = document.querySelector('#activities-table tbody');
  const activities = JSON.parse(localStorage.getItem('activities') || '[]');
  tbody.innerHTML = '';
  activities.forEach((a, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.name}</td>
      <td>${a.date}</td>
      <td><button class="btn" onclick="removeActivity(${i})">Remove</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function addActivity() {
  const name = document.getElementById('activityName').value.trim();
  const date = document.getElementById('activityDate').value;
  if (!name || !date) return alert('Fill all fields');
  const activities = JSON.parse(localStorage.getItem('activities') || '[]');
  activities.push({ name, date });
  activities.sort((a,b) => new Date(a.date) - new Date(b.date));
  localStorage.setItem('activities', JSON.stringify(activities));
  document.getElementById('activityName').value = '';
  document.getElementById('activityDate').value = '';
  renderActivities();
  alert('Activity added successfully! Visible to students.');
}

function removeActivity(i) {
  const activities = JSON.parse(localStorage.getItem('activities') || '[]');
  activities.splice(i, 1);
  localStorage.setItem('activities', JSON.stringify(activities));
  renderActivities();
}

// Indian Calendar for attendance
function renderCalendar() {
  const calendar = document.getElementById('calendarDays');
  calendar.innerHTML = '';
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();

  for (let day = 1; day <= daysInMonth; day++) {
    const dateObj = new Date(year, month, day);
    const isoString = dateObj.toISOString().split('T')[0];
    const btn = document.createElement('button');
    btn.innerText = day;
    btn.onclick = function() {
      setSelectedDate(isoString);
      renderAttendanceTable();
      Array.from(calendar.children).forEach(c => c.classList.remove('selected-day'));
      this.classList.add('selected-day');
    };
    if (isoString === selectedISODate) btn.classList.add('selected-day');
    calendar.appendChild(btn);
  }
}

function setSelectedDate(dateStr) {
  selectedDate = new Date(dateStr);
  selectedDate.setHours(0,0,0,0);
  selectedISODate = dateStr;
}

// Attendance Table
function renderAttendanceTable() {
  const tb = document.getElementById('students-body');
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  const records = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
  tb.innerHTML = '';
  students.forEach((s) => {
    const tr = document.createElement('tr');
    const dayRec = records[selectedISODate] || {};
    const status = dayRec[s.username] || '';
    tr.innerHTML = `
      <td>${s.name}</td>
      <td class="att-btns">
        <button class="btn ${status === 'Present' ? 'selected' : ''}" onclick="markAttendance('${s.username}', 'Present')">Present</button>
        <button class="btn ${status === 'Absent' ? 'selected' : ''}" onclick="markAttendance('${s.username}', 'Absent')">Absent</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function markAttendance(username, status) {
  if (!loggedIn) return alert('Please login first');
  const records = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
  if (!records[selectedISODate]) records[selectedISODate] = {};
  records[selectedISODate][username] = status;
  localStorage.setItem('attendanceRecords', JSON.stringify(records));
  renderAttendanceTable();
}

// Clear attendance for date
function clearAttendance() {
  if (!loggedIn) return alert('Please login first');
  if (!confirm(`Clear all attendance records for ${formatDateIndian(selectedISODate)}?`)) return;
  const records = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
  if(records[selectedISODate]) {
    delete records[selectedISODate];
    localStorage.setItem('attendanceRecords', JSON.stringify(records));
    renderAttendanceTable();
    alert('Cleared attendance for selected date.');
  } else {
    alert("No attendance records found for selected date.");
  }
}
// Format Indian date DD-MM-YYYY
function formatDateIndian(dateObj) {
  if (!dateObj) return '';
  let d = typeof dateObj === 'string' ? new Date(dateObj) : dateObj;
  let dd = String(d.getDate()).padStart(2, '0');
  let mm = String(d.getMonth() + 1).padStart(2, '0');
  let yyyy = d.getFullYear();
  return dd + '-' + mm + '-' + yyyy;
}

// Modal
function openModal(type) {
  if (!loggedIn) return alert('Please login first');
  const modal = document.getElementById('modal');
  const title = document.getElementById('modal-title');
  const body = document.getElementById('modal-body');
  body.innerHTML = '';
  title.innerText = '';
  if(type === 'qrAttendance') {
    title.innerText = 'QR Code Attendance';
    renderQrAttendance(body);
  }
  else if(type === 'studentAnalysis') {
    title.innerText = 'Student Attendance Analysis';
    renderAttendanceAnalysis(body);
  }
  else if(type === 'smartAttendance') {
    title.innerText = 'Smart Attendance (Camera)';
    renderSmartAttendance(body);
  }
  else if(type === 'timetable') {
    title.innerText = "Today's Timetable";
    const ttClone = document.getElementById('tt-card').cloneNode(true);
    ttClone.style.display = 'block';
    body.appendChild(ttClone);
  }
  else if(type === 'activities') {
    title.innerText = 'Activities';
    const actClone = document.getElementById('activities').cloneNode(true);
    actClone.style.display = 'block';
    body.appendChild(actClone);
  }
  else {
    title.innerText = type;
    body.innerHTML = `<p>${type} content goes here</p>`;
  }
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
  modal.focus();
}

function closeModal() {
  const modal = document.getElementById('modal');
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
  stopCamera();
}

// Attendance Analysis
function renderAttendanceAnalysis(container) {
  const records = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
  const students = JSON.parse(localStorage.getItem('students') || '[]');
  let html = '<table><thead><tr><th>Student</th><th>Present</th><th>Absent</th></tr></thead><tbody>';
  students.forEach(s => {
    let present = 0, absent = 0;
    for (const day in records) {
      if (records[day][s.username] === 'Present') present++;
      else if (records[day][s.username] === 'Absent') absent++;
    }
    html += `<tr><td>${s.name}</td><td>${present}</td><td>${absent}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// Smart Attendance with Face Recognition
function renderSmartAttendance(container) {
  container.innerHTML = `
      <video id="camVideo" autoplay muted playsinline style="border-radius:8px; width: 100%; height:220px; background:#000;"></video>
      <div style="margin-top: 1rem;">
        <button class="btn" id="startCameraBtn">Start Camera</button>
        <button disabled class="btn" id="stopCameraBtn">Stop Camera</button>
      </div>
      <div style="margin-top:1rem;">
        <p id="attendanceStatus" style="font-weight:bold;"></p>
      </div>
  `;

  const video = document.getElementById('camVideo');
  const startBtn = document.getElementById('startCameraBtn');
  const stopBtn = document.getElementById('stopCameraBtn');
  const statusEl = document.getElementById('attendanceStatus');

  let intervalId = null;

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
      cameraStream = stream;
      video.srcObject = stream;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.textContent = "Face recognition active, please look into the camera...";
      
      // Start recognition interval approx 1x per second
      intervalId = setInterval(recognizeFace, 1000);
    } catch(e) {
      alert('Failed to access camera: ' + e.message);
    }
  }

  function stopCamera() {
    if(cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    video.srcObject = null;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    statusEl.textContent = "Camera stopped.";
    if(intervalId) {
      clearInterval(intervalId);
      intervalId = null;
    }
  }

  startBtn.onclick = startCamera;
  stopBtn.onclick = stopCamera;

  // Perform face recognition on current video frame
  async function recognizeFace() {
    if(!faceMatcher) {
      statusEl.textContent = "No student face data available for matching.";
      return;
    }
    // detect all faces & descriptors in video frame
    const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
    if(!detection) {
      statusEl.textContent = "No face detected. Please try again.";
      return;
    }
    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
    if(bestMatch.label === 'unknown' || bestMatch.distance > 0.6) {
      // Not recognized
      statusEl.textContent = "User not recognized. Attendance not marked.";
      stopCamera();
      alert("User not defined in system. Attendance not marked.");
      return;
    }
    // Recognized user: mark present
    const username = bestMatch.label;
    markAttendance(username, 'Present');
    statusEl.textContent = `Attendance marked Present for: ${username}`;
    stopCamera();
    alert(`Attendance marked Present for: ${username}`);
  }
}

// Announcements and Quick Links management

function addAnnouncement() {
  if(!loggedIn) return alert('Please login first');
  const text = document.getElementById('newAnnouncement').value.trim();
  if (!text) return alert('Enter announcement text');
  let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
  announcements.unshift(text); // Add on top
  localStorage.setItem('announcements', JSON.stringify(announcements));
  document.getElementById('newAnnouncement').value = '';
  renderAnnouncements();
  renderStudentAnnouncements();
  alert('Announcement added.');
}

function removeAnnouncement(index) {
  if(!loggedIn) return alert('Please login first');
  let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
  announcements.splice(index, 1);
  localStorage.setItem('announcements', JSON.stringify(announcements));
  renderAnnouncements();
  renderStudentAnnouncements();
}

function addQuickLink() {
  if(!loggedIn) return alert('Please login first');
  const text = document.getElementById('newQuickLinkText').value.trim();
  const url = document.getElementById('newQuickLinkURL').value.trim();
  if (!text || !url) return alert('Fill link text and URL');
  // Basic URL validation
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    return alert('Enter a valid URL starting with http:// or https://');
  }
  let quickLinks = JSON.parse(localStorage.getItem('quickLinks') || '[]');
  quickLinks.unshift({text, url}); // Add on top
  localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
  document.getElementById('newQuickLinkText').value = '';
  document.getElementById('newQuickLinkURL').value = '';
  renderQuickLinks();
  renderStudentAnnouncements();
  alert('Quick link added.');
}

function removeQuickLink(index) {
  if(!loggedIn) return alert('Please login first');
  let quickLinks = JSON.parse(localStorage.getItem('quickLinks') || '[]');
  quickLinks.splice(index, 1);
  localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
  renderQuickLinks();
  renderStudentAnnouncements();
}

function renderAnnouncements() {
  const list = document.getElementById('announcementsList');
  let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
  list.innerHTML = '';
  announcements.forEach((a, i) => {
    const li = document.createElement('li');
    li.style.marginBottom = '0.5rem';
    li.innerHTML = `
      ${a} <button class="btn" onclick="removeAnnouncement(${i})">Remove</button>
    `;
    list.appendChild(li);
  });
}

function renderQuickLinks() {
  const list = document.getElementById('quickLinksList');
  let quickLinks = JSON.parse(localStorage.getItem('quickLinks') || '[]');
  list.innerHTML = '';
  quickLinks.forEach((link, i) => {
    const li = document.createElement('li');
    li.style.marginBottom = '0.5rem';
    li.innerHTML = `
      <a href="${link.url}" target="_blank" rel="noopener">${link.text}</a>
      <button class="btn" onclick="removeQuickLink(${i})">Remove</button>
    `;
    list.appendChild(li);
  });
}

function renderStudentAnnouncements() {
  const container = document.getElementById('studentAnnouncementsContent');
  let announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
  let quickLinks = JSON.parse(localStorage.getItem('quickLinks') || '[]');

  let html = '';
  if (announcements.length > 0) {
    html += '<h3>Latest Announcements</h3><ul>';
    announcements.forEach(a => {
      html += `<li>${a}</li>`;
    });
    html += '</ul>';
  } else {
    html += '<p>No announcements at the moment.</p>';
  }

  if (quickLinks.length > 0) {
    html += '<h3>Quick Links</h3><ul>';
    quickLinks.forEach(link => {
      html += `<li><a href="${link.url}" target="_blank" rel="noopener">${link.text}</a></li>`;
    });
    html += '</ul>';
  }

  container.innerHTML = html;
}

// Initialize calendar and page on load
window.onload = () => {
  document.querySelectorAll('section').forEach(s => s.style.display = 'none');
  document.getElementById('loginPage').style.display = 'flex';
}

document.getElementById('facultyLogoutBtn').addEventListener('click', () => {
  loggedIn = false;
  document.querySelectorAll('section').forEach(s => s.style.display = 'none');
  const loginPage = document.getElementById('loginPage');
  loginPage.style.display = 'flex';
  loginPage.classList.remove('hidden');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('facultyLogoutBtn').style.display = 'none';
});
</script>

</body>
</html>
